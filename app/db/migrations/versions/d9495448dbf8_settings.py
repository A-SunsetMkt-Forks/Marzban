"""settings

Revision ID: d9495448dbf8
Revises: e56f1c781e46
Create Date: 2023-11-22 16:10:23.005420

"""
import sqlalchemy as sa
from alembic import op

import config

# revision identifiers, used by Alembic.
revision = 'd9495448dbf8'
down_revision = 'e56f1c781e46'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    table = op.create_table('settings',
                            sa.Column('id', sa.Integer(), nullable=False),
                            sa.Column('dashboard_path', sa.String(length=256), nullable=False),
                            sa.Column('subscription_url_prefix', sa.String(length=256), nullable=True),
                            sa.Column('subscription_page_title', sa.String(length=128), nullable=False),
                            sa.Column('subscription_support_url_header', sa.String(length=256), nullable=True),
                            sa.Column('subscription_update_interval_header', sa.Integer(), nullable=True),
                            sa.Column('webhook_url', sa.String(length=256), nullable=True),
                            sa.Column('webhook_secret', sa.String(length=256), nullable=True),
                            sa.Column('telegram_api_token', sa.String(length=64), nullable=True),
                            sa.Column('telegram_admin_ids', sa.String(length=256), nullable=True),
                            sa.Column('telegram_logs_channel_id', sa.String(length=64), nullable=True),
                            sa.Column('discord_webhook_url', sa.String(length=256), nullable=True),
                            sa.Column('jwt_token_expire_minutes', sa.Integer(), nullable=True),
                            sa.PrimaryKeyConstraint('id')
                            )
    # ### end Alembic commands ###
    try:
        SUB_UPDATE_INTERVAL = int(config.SUB_UPDATE_INTERVAL)
    except ValueError:
        SUB_UPDATE_INTERVAL = None

    try:
        JWT_ACCESS_TOKEN_EXPIRE_MINUTES = int(config.JWT_ACCESS_TOKEN_EXPIRE_MINUTES)
    except ValueError:
        JWT_ACCESS_TOKEN_EXPIRE_MINUTES = None

    op.bulk_insert(table, [
        {
            "dashboard_path": "/dashboard",
            "subscription_url_prefix": config.XRAY_SUBSCRIPTION_URL_PREFIX or None,
            "subscription_page_title": config.SUB_PROFILE_TITLE or None,
            "subscription_support_url_header": config.SUB_SUPPORT_URL or None,
            "subscription_update_interval_header": SUB_UPDATE_INTERVAL,
            "webhook_url": config.WEBHOOK_ADDRESS or None,
            "webhook_secret": config.WEBHOOK_SECRET or None,
            "telegram_api_token": config.TELEGRAM_API_TOKEN or None,
            "telegram_admin_ids": ','.join(map(str, config.TELEGRAM_ADMIN_ID)) if config.TELEGRAM_ADMIN_ID else None,
            "telegram_logs_channel_id": config.TELEGRAM_LOGGER_CHANNEL_ID or None,
            "discord_webhook_url": config.DISCORD_WEBHOOK_URL or None,
            "jwt_token_expire_minutes": JWT_ACCESS_TOKEN_EXPIRE_MINUTES,
        }
    ])


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('settings')
    # ### end Alembic commands ###
